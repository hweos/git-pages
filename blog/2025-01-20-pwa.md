---
slug: pwa-guide
title: PWA æ¸è¿›å¼åº”ç”¨å¼€å‘æŒ‡å—
authors: mason
tags: [PWA, å‰ç«¯, ç§»åŠ¨ç«¯]
---

PWA è®© Web åº”ç”¨æ‹¥æœ‰æ¥è¿‘åŸç”Ÿåº”ç”¨çš„ä½“éªŒã€‚æœ¬æ–‡ä»‹ç» PWA çš„æ ¸å¿ƒæŠ€æœ¯å’Œå®ç°æ–¹æ³•ã€‚

<!--truncate-->

## ğŸ¯ ä»€ä¹ˆæ˜¯ PWA

PWA (Progressive Web App) æ˜¯ä¸€ç§ Web åº”ç”¨ï¼Œå…·å¤‡ï¼š

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| å¯å®‰è£… | æ·»åŠ åˆ°ä¸»å±å¹• |
| ç¦»çº¿å¯ç”¨ | Service Worker ç¼“å­˜ |
| æ¨é€é€šçŸ¥ | ç”¨æˆ·å¬å› |
| å“åº”å¼ | é€‚é…å„ç§è®¾å¤‡ |
| å®‰å…¨ | å¿…é¡» HTTPS |

---

## ğŸ“‹ æ ¸å¿ƒç»„ä»¶

### 1. Web App Manifest

```json
// public/manifest.json
{
  "name": "My PWA App",
  "short_name": "MyApp",
  "description": "A Progressive Web App",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#3b82f6",
  "orientation": "portrait",
  "icons": [
    {
      "src": "/icons/icon-192.png",
      "sizes": "192x192",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "/icons/icon-512.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ],
  "screenshots": [
    {
      "src": "/screenshots/home.png",
      "sizes": "1280x720",
      "type": "image/png"
    }
  ]
}
```

```html
<!-- index.html -->
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#3b82f6">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-icon" href="/icons/icon-192.png">
```

### 2. Service Worker

```javascript
// sw.js
const CACHE_NAME = 'my-pwa-v1';
const ASSETS = [
  '/',
  '/index.html',
  '/styles.css',
  '/app.js',
  '/icons/icon-192.png',
];

// å®‰è£…
self.addEventListener('install', (event) => {
  event.waitUntil(
    caches.open(CACHE_NAME).then((cache) => {
      console.log('Caching assets');
      return cache.addAll(ASSETS);
    })
  );
  self.skipWaiting();
});

// æ¿€æ´»
self.addEventListener('activate', (event) => {
  event.waitUntil(
    caches.keys().then((keys) => {
      return Promise.all(
        keys
          .filter((key) => key !== CACHE_NAME)
          .map((key) => caches.delete(key))
      );
    })
  );
  self.clients.claim();
});

// è¯·æ±‚æ‹¦æˆª
self.addEventListener('fetch', (event) => {
  event.respondWith(
    caches.match(event.request).then((cached) => {
      return cached || fetch(event.request);
    })
  );
});
```

### æ³¨å†Œ Service Worker

```javascript
// main.js
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker
      .register('/sw.js')
      .then((reg) => {
        console.log('SW registered:', reg.scope);
      })
      .catch((err) => {
        console.log('SW registration failed:', err);
      });
  });
}
```

---

## ğŸ’¾ ç¼“å­˜ç­–ç•¥

### Cache First

```javascript
// ä¼˜å…ˆç¼“å­˜ï¼Œé€‚åˆé™æ€èµ„æº
self.addEventListener('fetch', (event) => {
  event.respondWith(
    caches.match(event.request).then((cached) => {
      return cached || fetch(event.request).then((response) => {
        return caches.open(CACHE_NAME).then((cache) => {
          cache.put(event.request, response.clone());
          return response;
        });
      });
    })
  );
});
```

### Network First

```javascript
// ä¼˜å…ˆç½‘ç»œï¼Œé€‚åˆ API è¯·æ±‚
self.addEventListener('fetch', (event) => {
  event.respondWith(
    fetch(event.request)
      .then((response) => {
        const clone = response.clone();
        caches.open(CACHE_NAME).then((cache) => {
          cache.put(event.request, clone);
        });
        return response;
      })
      .catch(() => caches.match(event.request))
  );
});
```

### Stale While Revalidate

```javascript
// è¿”å›ç¼“å­˜ï¼ŒåŒæ—¶æ›´æ–°
self.addEventListener('fetch', (event) => {
  event.respondWith(
    caches.open(CACHE_NAME).then((cache) => {
      return cache.match(event.request).then((cached) => {
        const fetchPromise = fetch(event.request).then((response) => {
          cache.put(event.request, response.clone());
          return response;
        });
        return cached || fetchPromise;
      });
    })
  );
});
```

---

## ğŸ“² å®‰è£…æç¤º

```javascript
let deferredPrompt;

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  showInstallButton();
});

async function handleInstallClick() {
  if (!deferredPrompt) return;
  
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  
  console.log(`User ${outcome === 'accepted' ? 'accepted' : 'dismissed'} install`);
  deferredPrompt = null;
  hideInstallButton();
}

window.addEventListener('appinstalled', () => {
  console.log('App installed');
  hideInstallButton();
});
```

---

## ğŸ”” æ¨é€é€šçŸ¥

### è¯·æ±‚æƒé™

```javascript
async function requestNotificationPermission() {
  const permission = await Notification.requestPermission();
  
  if (permission === 'granted') {
    console.log('Notification permission granted');
    subscribeToNotifications();
  }
}
```

### è®¢é˜…æ¨é€

```javascript
async function subscribeToNotifications() {
  const registration = await navigator.serviceWorker.ready;
  
  const subscription = await registration.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY),
  });

  // å‘é€åˆ°æœåŠ¡å™¨
  await fetch('/api/subscribe', {
    method: 'POST',
    body: JSON.stringify(subscription),
  });
}
```

### æ¥æ”¶æ¨é€ (Service Worker)

```javascript
self.addEventListener('push', (event) => {
  const data = event.data?.json() || {};
  
  event.waitUntil(
    self.registration.showNotification(data.title, {
      body: data.body,
      icon: '/icons/icon-192.png',
      badge: '/icons/badge.png',
      data: { url: data.url },
    })
  );
});

self.addEventListener('notificationclick', (event) => {
  event.notification.close();
  
  event.waitUntil(
    clients.openWindow(event.notification.data.url)
  );
});
```

---

## ğŸ› ï¸ Workbox ç®€åŒ–å¼€å‘

```bash
npm install workbox-cli --save-dev
```

```javascript
// sw.js with Workbox
import { precacheAndRoute } from 'workbox-precaching';
import { registerRoute } from 'workbox-routing';
import { CacheFirst, NetworkFirst, StaleWhileRevalidate } from 'workbox-strategies';
import { ExpirationPlugin } from 'workbox-expiration';

// é¢„ç¼“å­˜
precacheAndRoute(self.__WB_MANIFEST);

// å›¾ç‰‡ç¼“å­˜
registerRoute(
  ({ request }) => request.destination === 'image',
  new CacheFirst({
    cacheName: 'images',
    plugins: [
      new ExpirationPlugin({
        maxEntries: 50,
        maxAgeSeconds: 30 * 24 * 60 * 60, // 30 days
      }),
    ],
  })
);

// API è¯·æ±‚
registerRoute(
  ({ url }) => url.pathname.startsWith('/api'),
  new NetworkFirst({
    cacheName: 'api-cache',
  })
);

// é™æ€èµ„æº
registerRoute(
  ({ request }) => ['style', 'script', 'font'].includes(request.destination),
  new StaleWhileRevalidate({
    cacheName: 'static-resources',
  })
);
```

---

## ğŸ“± æ¡†æ¶é›†æˆ

### Next.js

```bash
npm install next-pwa
```

```javascript
// next.config.js
const withPWA = require('next-pwa')({
  dest: 'public',
  register: true,
  skipWaiting: true,
  disable: process.env.NODE_ENV === 'development',
});

module.exports = withPWA({
  // next config
});
```

### Vite

```bash
npm install vite-plugin-pwa
```

```javascript
// vite.config.js
import { VitePWA } from 'vite-plugin-pwa';

export default {
  plugins: [
    VitePWA({
      registerType: 'autoUpdate',
      manifest: {
        name: 'My App',
        short_name: 'App',
        theme_color: '#3b82f6',
      },
      workbox: {
        globPatterns: ['**/*.{js,css,html,ico,png,svg}'],
      },
    }),
  ],
};
```

---

## âœ… PWA æ£€æŸ¥æ¸…å•

```markdown
åŸºç¡€è¦æ±‚ï¼š
- [ ] HTTPS
- [ ] Web App Manifest
- [ ] Service Worker
- [ ] å“åº”å¼è®¾è®¡
- [ ] ç¦»çº¿é¡µé¢

å¢å¼ºåŠŸèƒ½ï¼š
- [ ] å®‰è£…æç¤º
- [ ] æ¨é€é€šçŸ¥
- [ ] åå°åŒæ­¥
- [ ] åˆ†äº« API

æ€§èƒ½ï¼š
- [ ] å¿«é€Ÿé¦–å±
- [ ] èµ„æºé¢„ç¼“å­˜
- [ ] å›¾ç‰‡ä¼˜åŒ–
```

---

## ğŸ”§ è°ƒè¯•å·¥å…·

```markdown
Chrome DevTools:
1. Application â†’ Manifestï¼šæ£€æŸ¥æ¸…å•
2. Application â†’ Service Workersï¼šè°ƒè¯• SW
3. Application â†’ Cache Storageï¼šæŸ¥çœ‹ç¼“å­˜
4. Lighthouse â†’ PWAï¼šè¯„åˆ†æ£€æµ‹
```

---

PWA è®© Web åº”ç”¨æ›´æ¥è¿‘åŸç”Ÿä½“éªŒï¼Œæ˜¯æå‡ç”¨æˆ·å‚ä¸åº¦çš„æœ‰æ•ˆæ‰‹æ®µã€‚
