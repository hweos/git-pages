---
slug: cicd-pipeline
title: CI/CD æµæ°´çº¿æ­å»ºæŒ‡å—
authors: mason
tags: [CI/CD, DevOps, GitHub Actions]
---

CI/CD æ˜¯ç°ä»£è½¯ä»¶å¼€å‘çš„åŸºçŸ³ã€‚æœ¬æ–‡ä»‹ç»å¦‚ä½•ä½¿ç”¨ GitHub Actions æ­å»ºè‡ªåŠ¨åŒ–æµæ°´çº¿ã€‚

<!--truncate-->

## ğŸ¯ ä»€ä¹ˆæ˜¯ CI/CD

| æ¦‚å¿µ | å…¨ç§° | å«ä¹‰ |
|------|------|------|
| CI | Continuous Integration | æŒç»­é›†æˆï¼šè‡ªåŠ¨æµ‹è¯•ã€æ„å»º |
| CD | Continuous Delivery | æŒç»­äº¤ä»˜ï¼šè‡ªåŠ¨éƒ¨ç½²åˆ°é¢„å‘ç¯å¢ƒ |
| CD | Continuous Deployment | æŒç»­éƒ¨ç½²ï¼šè‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ |

### å…¸å‹æµç¨‹

```
ä»£ç æäº¤ â†’ è‡ªåŠ¨æµ‹è¯• â†’ ä»£ç æ£€æŸ¥ â†’ æ„å»º â†’ éƒ¨ç½²
```

---

## ğŸš€ GitHub Actions åŸºç¡€

### å·¥ä½œæµæ–‡ä»¶

```yaml
# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Run lint
        run: npm run lint
```

### æ ¸å¿ƒæ¦‚å¿µ

| æ¦‚å¿µ | è¯´æ˜ |
|------|------|
| Workflow | å·¥ä½œæµï¼Œå®šä¹‰è‡ªåŠ¨åŒ–æµç¨‹ |
| Event | è§¦å‘äº‹ä»¶ï¼ˆpush, PR, scheduleï¼‰ |
| Job | ä»»åŠ¡ï¼Œå¯å¹¶è¡Œæ‰§è¡Œ |
| Step | æ­¥éª¤ï¼ŒæŒ‰é¡ºåºæ‰§è¡Œ |
| Action | å¯å¤ç”¨çš„æ“ä½œå•å…ƒ |
| Runner | æ‰§è¡Œç¯å¢ƒ |

---

## ğŸ“‹ å¸¸ç”¨è§¦å‘å™¨

```yaml
on:
  # æ¨é€è§¦å‘
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'package.json'
    paths-ignore:
      - '**.md'
      - 'docs/**'

  # PR è§¦å‘
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

  # å®šæ—¶è§¦å‘
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©å‡Œæ™¨ 2 ç‚¹

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deploy environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

  # å…¶ä»–å·¥ä½œæµè§¦å‘
  workflow_call:
```

---

## ğŸ”§ å®Œæ•´ CI æµæ°´çº¿

```yaml
name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - run: npm ci
      - run: npm run lint
      - run: npm run type-check

  # å•å…ƒæµ‹è¯•
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - run: npm ci
      - run: npm test -- --coverage
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

  # æ„å»º
  build:
    runs-on: ubuntu-latest
    needs: [lint, test]  # ä¾èµ–å‰é¢çš„ä»»åŠ¡
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - run: npm ci
      - run: npm run build
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build
          path: dist/
          retention-days: 7

  # E2E æµ‹è¯•
  e2e:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - run: npm ci
      
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build
          path: dist/
      
      - name: Run E2E tests
        run: npm run test:e2e
```

---

## ğŸš¢ éƒ¨ç½²æµæ°´çº¿

### éƒ¨ç½²åˆ° Vercel

```yaml
name: Deploy to Vercel

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
```

### éƒ¨ç½²åˆ°æœåŠ¡å™¨

```yaml
name: Deploy to Server

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci
      - run: npm run build

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /var/www/app
            git pull origin main
            npm ci --production
            npm run build
            pm2 restart app
```

### Docker éƒ¨ç½²

```yaml
name: Docker Build and Deploy

on:
  push:
    branches: [main]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            username/app:latest
            username/app:${{ github.sha }}

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            docker pull username/app:latest
            docker stop app || true
            docker rm app || true
            docker run -d --name app -p 3000:3000 username/app:latest
```

---

## ğŸ” Secrets ç®¡ç†

### è®¾ç½® Secrets

```markdown
1. ä»“åº“ Settings â†’ Secrets and variables â†’ Actions
2. New repository secret
3. æ·»åŠ æ•æ„Ÿä¿¡æ¯
```

### ä½¿ç”¨ Secrets

```yaml
env:
  API_KEY: ${{ secrets.API_KEY }}

steps:
  - name: Deploy
    run: ./deploy.sh
    env:
      SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
```

### ç¯å¢ƒ Secrets

```yaml
jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production  # ä½¿ç”¨ production ç¯å¢ƒçš„ secrets
    steps:
      - run: echo ${{ secrets.PROD_API_KEY }}
```

---

## ğŸ“Š Matrix ç­–ç•¥

```yaml
jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node: [18, 20, 22]
        exclude:
          - os: windows-latest
            node: 18
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
      - run: npm ci
      - run: npm test
```

---

## ğŸ’¾ ç¼“å­˜ä¼˜åŒ–

```yaml
steps:
  - uses: actions/checkout@v4

  - uses: actions/setup-node@v4
    with:
      node-version: '20'
      cache: 'npm'  # è‡ªåŠ¨ç¼“å­˜

  # æˆ–è€…æ‰‹åŠ¨ç¼“å­˜
  - name: Cache node_modules
    uses: actions/cache@v4
    with:
      path: node_modules
      key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
      restore-keys: |
        ${{ runner.os }}-node-
```

---

## ğŸ“‹ æœ€ä½³å®è·µ

```markdown
1. ä¿æŒæµæ°´çº¿å¿«é€Ÿï¼ˆ< 10 åˆ†é’Ÿï¼‰
2. å¹¶è¡Œæ‰§è¡Œç‹¬ç«‹ä»»åŠ¡
3. ä½¿ç”¨ç¼“å­˜åŠ é€Ÿæ„å»º
4. åªåœ¨å¿…è¦æ—¶è§¦å‘
5. åˆç†ä½¿ç”¨ Secrets
6. æ·»åŠ è¶…æ—¶é™åˆ¶
7. é€šçŸ¥æ„å»ºç»“æœ
```

### é€šçŸ¥

```yaml
- name: Notify on failure
  if: failure()
  uses: 8398a7/action-slack@v3
  with:
    status: ${{ job.status }}
    channel: '#deployments'
  env:
    SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
```

---

CI/CD æ˜¯å›¢é˜Ÿæ•ˆç‡çš„å€å¢å™¨ã€‚ä»ç®€å•çš„æµæ°´çº¿å¼€å§‹ï¼Œé€æ­¥å®Œå–„ã€‚
