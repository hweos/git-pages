---
slug: npm-pnpm-guide
title: npm/pnpm åŒ…ç®¡ç†å®è·µæŒ‡å—
authors: mason
tags: [npm, pnpm, å·¥å…·, å‰ç«¯å·¥ç¨‹åŒ–]
---

åŒ…ç®¡ç†å™¨æ˜¯å‰ç«¯å¼€å‘çš„åŸºç¡€å·¥å…·ã€‚æœ¬æ–‡å¯¹æ¯” npm å’Œ pnpmï¼Œåˆ†äº«æœ€ä½³å®è·µã€‚

<!--truncate-->

## ğŸ“¦ åŒ…ç®¡ç†å™¨å¯¹æ¯”

| ç‰¹æ€§ | npm | pnpm |
|------|-----|------|
| å®‰è£…é€Ÿåº¦ | æ…¢ | å¿« 2-3 å€ |
| ç£ç›˜å ç”¨ | å¤§ï¼ˆé‡å¤å®‰è£…ï¼‰ | å°ï¼ˆç¡¬é“¾æ¥ï¼‰ |
| node_modules ç»“æ„ | æ‰å¹³åŒ– | ç¬¦å·é“¾æ¥ |
| å¹½çµä¾èµ– | å­˜åœ¨ | é¿å… |
| Monorepo æ”¯æŒ | workspaces | å†…ç½® workspace |

---

## ğŸš€ pnpm å¿«é€Ÿä¸Šæ‰‹

### å®‰è£…

```bash
# ä½¿ç”¨ npm å®‰è£…
npm install -g pnpm

# ä½¿ç”¨ Homebrew
brew install pnpm

# ä½¿ç”¨ corepack (Node.js 16.13+)
corepack enable
corepack prepare pnpm@latest --activate
```

### å¸¸ç”¨å‘½ä»¤

```bash
# å®‰è£…ä¾èµ–
pnpm install
pnpm i

# æ·»åŠ ä¾èµ–
pnpm add lodash
pnpm add -D typescript    # devDependencies
pnpm add -g serve         # å…¨å±€å®‰è£…

# ç§»é™¤ä¾èµ–
pnpm remove lodash
pnpm rm lodash

# æ›´æ–°ä¾èµ–
pnpm update
pnpm up lodash
pnpm up --latest          # æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬

# è¿è¡Œè„šæœ¬
pnpm run dev
pnpm dev                  # ç®€å†™

# æ‰§è¡Œå‘½ä»¤
pnpm exec tsc
pnpm dlx create-react-app my-app  # ç±»ä¼¼ npx
```

---

## ğŸ“‹ package.json è¯¦è§£

### åŸºæœ¬ç»“æ„

```json
{
  "name": "my-project",
  "version": "1.0.0",
  "description": "é¡¹ç›®æè¿°",
  "main": "dist/index.js",
  "module": "dist/index.mjs",
  "types": "dist/index.d.ts",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "test": "vitest"
  },
  "dependencies": {
    "react": "^18.2.0"
  },
  "devDependencies": {
    "typescript": "^5.0.0"
  }
}
```

### ç‰ˆæœ¬å·è§„åˆ™

```markdown
ä¸»ç‰ˆæœ¬.æ¬¡ç‰ˆæœ¬.è¡¥ä¸ç‰ˆæœ¬
  ^     ~     æ— å‰ç¼€

^18.2.0  â†’ >=18.2.0 <19.0.0  (å…è®¸æ¬¡ç‰ˆæœ¬å’Œè¡¥ä¸æ›´æ–°)
~18.2.0  â†’ >=18.2.0 <18.3.0  (åªå…è®¸è¡¥ä¸æ›´æ–°)
18.2.0   â†’ ç²¾ç¡®ç‰ˆæœ¬
*        â†’ ä»»æ„ç‰ˆæœ¬
>=18.0.0 â†’ å¤§äºç­‰äº
```

### ä¾èµ–ç±»å‹

```json
{
  "dependencies": {
    // ç”Ÿäº§ä¾èµ–ï¼Œæ‰“åŒ…ä¼šåŒ…å«
  },
  "devDependencies": {
    // å¼€å‘ä¾èµ–ï¼Œæ‰“åŒ…ä¸åŒ…å«
  },
  "peerDependencies": {
    // å¯¹ç­‰ä¾èµ–ï¼Œå®¿ä¸»é¡¹ç›®éœ€è¦å®‰è£…
    "react": "^18.0.0"
  },
  "optionalDependencies": {
    // å¯é€‰ä¾èµ–ï¼Œå®‰è£…å¤±è´¥ä¸ä¼šæŠ¥é”™
  }
}
```

---

## ğŸ”’ é”æ–‡ä»¶

### package-lock.json (npm)

```json
{
  "name": "my-project",
  "lockfileVersion": 3,
  "packages": {
    "node_modules/lodash": {
      "version": "4.17.21",
      "resolved": "https://registry.npmjs.org/lodash/-/lodash-4.17.21.tgz",
      "integrity": "sha512-..."
    }
  }
}
```

### pnpm-lock.yaml

```yaml
lockfileVersion: '6.0'
dependencies:
  lodash:
    specifier: ^4.17.21
    version: 4.17.21
packages:
  /lodash@4.17.21:
    resolution: {integrity: sha512-...}
```

### æœ€ä½³å®è·µ

```markdown
âœ… æäº¤é”æ–‡ä»¶åˆ° Git
âœ… ä¸è¦æ‰‹åŠ¨ä¿®æ”¹é”æ–‡ä»¶
âœ… å›¢é˜Ÿä½¿ç”¨ç›¸åŒåŒ…ç®¡ç†å™¨
âœ… CI ä½¿ç”¨ npm ci / pnpm install --frozen-lockfile
```

---

## âš™ï¸ é…ç½®æ–‡ä»¶

### .npmrc

```ini
# é•œåƒæº
registry=https://registry.npmmirror.com

# ç§æœ‰ä»“åº“
@mycompany:registry=https://npm.mycompany.com

# è®¤è¯
//npm.mycompany.com/:_authToken=${NPM_TOKEN}

# å…¶ä»–é…ç½®
save-exact=true
engine-strict=true
```

### .nvmrc

```
18.17.0
```

### engines å­—æ®µ

```json
{
  "engines": {
    "node": ">=18.0.0",
    "pnpm": ">=8.0.0"
  }
}
```

---

## ğŸ› ï¸ å®ç”¨æŠ€å·§

### 1. æŸ¥çœ‹ä¾èµ–ä¿¡æ¯

```bash
# æŸ¥çœ‹åŒ…ä¿¡æ¯
npm info lodash
pnpm info lodash

# æŸ¥çœ‹å·²å®‰è£…ç‰ˆæœ¬
npm ls lodash
pnpm ls lodash

# æŸ¥çœ‹è¿‡æœŸä¾èµ–
npm outdated
pnpm outdated

# æŸ¥çœ‹ä¾èµ–æ ‘
npm ls --all
pnpm ls --depth 3
```

### 2. æ¸…ç†ç¼“å­˜

```bash
# npm
npm cache clean --force

# pnpm
pnpm store prune
pnpm store path  # æŸ¥çœ‹å­˜å‚¨è·¯å¾„
```

### 3. å®‰å…¨å®¡è®¡

```bash
# å®‰å…¨æ£€æŸ¥
npm audit
pnpm audit

# è‡ªåŠ¨ä¿®å¤
npm audit fix
```

### 4. å‘å¸ƒåŒ…

```bash
# ç™»å½•
npm login
pnpm login

# å‘å¸ƒ
npm publish
pnpm publish

# å‘å¸ƒæµ‹è¯•ç‰ˆ
npm publish --tag beta

# è®¾ç½®ç‰ˆæœ¬
npm version patch  # 1.0.0 -> 1.0.1
npm version minor  # 1.0.0 -> 1.1.0
npm version major  # 1.0.0 -> 2.0.0
```

---

## ğŸ“‚ Workspaces

### pnpm-workspace.yaml

```yaml
packages:
  - 'packages/*'
  - 'apps/*'
```

### ç›®å½•ç»“æ„

```
my-monorepo/
â”œâ”€â”€ package.json
â”œâ”€â”€ pnpm-workspace.yaml
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ shared/
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ package.json
â””â”€â”€ apps/
    â”œâ”€â”€ web/
    â”‚   â””â”€â”€ package.json
    â””â”€â”€ api/
        â””â”€â”€ package.json
```

### Workspace å‘½ä»¤

```bash
# å®‰è£…æ‰€æœ‰åŒ…çš„ä¾èµ–
pnpm install

# åœ¨ç‰¹å®šåŒ…ä¸­è¿è¡Œå‘½ä»¤
pnpm --filter @myorg/web dev
pnpm -F @myorg/web dev

# åœ¨æ‰€æœ‰åŒ…ä¸­è¿è¡Œå‘½ä»¤
pnpm -r build
pnpm --recursive build

# æ·»åŠ åŒ…ä¹‹é—´çš„ä¾èµ–
pnpm -F @myorg/web add @myorg/shared

# æ·»åŠ å¤–éƒ¨ä¾èµ–åˆ°ç‰¹å®šåŒ…
pnpm -F @myorg/web add lodash

# æ·»åŠ åˆ°æ ¹é¡¹ç›®
pnpm add -w typescript
```

---

## ğŸ”§ è„šæœ¬æŠ€å·§

### å¹¶è¡Œ/ä¸²è¡Œæ‰§è¡Œ

```json
{
  "scripts": {
    "build:all": "pnpm -r build",
    "dev": "pnpm -r --parallel dev",
    "test": "pnpm -r --sequential test"
  }
}
```

### å‰ç½®/åç½®è„šæœ¬

```json
{
  "scripts": {
    "prebuild": "rm -rf dist",
    "build": "tsc",
    "postbuild": "echo 'Build complete!'"
  }
}
```

### è·¨å¹³å°è„šæœ¬

```bash
# å®‰è£… cross-env
pnpm add -D cross-env

# ä½¿ç”¨
"scripts": {
  "build": "cross-env NODE_ENV=production webpack"
}
```

---

## â“ å¸¸è§é—®é¢˜

### å¹½çµä¾èµ–

```markdown
é—®é¢˜ï¼šé¡¹ç›®ä¸­ä½¿ç”¨äº†æœªå£°æ˜çš„ä¾èµ–ï¼ˆé€šè¿‡å…¶ä»–åŒ…é—´æ¥å®‰è£…ï¼‰

npmï¼šæ‰å¹³åŒ–å®‰è£…ï¼Œå¯èƒ½å¯ä»¥ä½¿ç”¨æœªå£°æ˜çš„åŒ…
pnpmï¼šä¸¥æ ¼æ¨¡å¼ï¼Œå¿…é¡»æ˜¾å¼å£°æ˜

è§£å†³ï¼šä½¿ç”¨ pnpm æˆ–æ˜ç¡®å£°æ˜æ‰€æœ‰ä½¿ç”¨çš„ä¾èµ–
```

### ä¾èµ–å†²çª

```bash
# æŸ¥çœ‹ä¸ºä»€ä¹ˆå®‰è£…äº†æŸä¸ªç‰ˆæœ¬
pnpm why lodash

# å¼ºåˆ¶ä½¿ç”¨ç‰¹å®šç‰ˆæœ¬
# package.json
{
  "pnpm": {
    "overrides": {
      "lodash": "4.17.21"
    }
  }
}
```

### å®‰è£…å¤±è´¥

```bash
# æ¸…ç†é‡è¯•
rm -rf node_modules
rm pnpm-lock.yaml
pnpm install

# å¿½ç•¥è„šæœ¬
pnpm install --ignore-scripts
```

---

## ğŸ“š æ¨èé…ç½®

```json
{
  "scripts": {
    "preinstall": "npx only-allow pnpm"
  },
  "packageManager": "pnpm@8.10.0",
  "engines": {
    "node": ">=18.0.0",
    "pnpm": ">=8.0.0"
  }
}
```

---

é€‰æ‹© pnpm å¯ä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½å’Œæ›´ä¸¥æ ¼çš„ä¾èµ–ç®¡ç†ã€‚å¯¹äºæ–°é¡¹ç›®ï¼Œæ¨èä½¿ç”¨ pnpmã€‚
