---
slug: monorepo-guide
title: Monorepo å®è·µæŒ‡å—
authors: mason
tags: [Monorepo, pnpm, Turborepo, å·¥ç¨‹åŒ–]
---

Monorepo å°†å¤šä¸ªé¡¹ç›®æ”¾åœ¨ä¸€ä¸ªä»“åº“ç®¡ç†ï¼Œä¾¿äºä»£ç å…±äº«å’Œç»Ÿä¸€å·¥å…·é“¾ã€‚æœ¬æ–‡ä»‹ç» Monorepo çš„æ­å»ºå’Œæœ€ä½³å®è·µã€‚

<!--truncate-->

## ğŸ¯ ä»€ä¹ˆæ˜¯ Monorepo

```markdown
Monorepoï¼šå¤šä¸ªé¡¹ç›®åœ¨ä¸€ä¸ª Git ä»“åº“ä¸­
Polyrepoï¼šæ¯ä¸ªé¡¹ç›®ä¸€ä¸ªç‹¬ç«‹ä»“åº“

Monorepo ä¸ç­‰äº Monolithï¼ˆå•ä½“åº”ç”¨ï¼‰
```

### ä¼˜ç¼ºç‚¹

| ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|
| ä»£ç å¤ç”¨ç®€å• | ä»“åº“ä½“ç§¯å¤§ |
| ç»Ÿä¸€å·¥å…·é“¾ | æƒé™ç®¡ç†å¤æ‚ |
| åŸå­åŒ–æäº¤ | CI/CD éœ€è¦ä¼˜åŒ– |
| ä¾èµ–ç®¡ç†ç»Ÿä¸€ | å­¦ä¹ æˆæœ¬ |
| é‡æ„æ›´æ–¹ä¾¿ | |

---

## ğŸ› ï¸ å·¥å…·é€‰æ‹©

| å·¥å…· | åŒ…ç®¡ç† | æ„å»ºç¼“å­˜ | ä»»åŠ¡ç¼–æ’ |
|------|--------|----------|----------|
| pnpm workspace | âœ… | âŒ | âŒ |
| Turborepo | âŒ | âœ… | âœ… |
| Nx | âŒ | âœ… | âœ… |
| Lerna | âœ… | âŒ | âœ… |

**æ¨èç»„åˆ**ï¼špnpm + Turborepo

---

## ğŸ“‚ é¡¹ç›®ç»“æ„

```
my-monorepo/
â”œâ”€â”€ package.json
â”œâ”€â”€ pnpm-workspace.yaml
â”œâ”€â”€ turbo.json
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ web/                 # Next.js åº”ç”¨
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ src/
â”‚   â”œâ”€â”€ admin/               # ç®¡ç†åå°
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ src/
â”‚   â””â”€â”€ docs/                # æ–‡æ¡£ç«™
â”‚       â”œâ”€â”€ package.json
â”‚       â””â”€â”€ src/
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ ui/                  # å…±äº« UI ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ src/
â”‚   â”œâ”€â”€ utils/               # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ src/
â”‚   â””â”€â”€ config/              # å…±äº«é…ç½®
â”‚       â”œâ”€â”€ package.json
â”‚       â”œâ”€â”€ eslint/
â”‚       â””â”€â”€ typescript/
â””â”€â”€ tooling/
    â””â”€â”€ scripts/             # å·¥å…·è„šæœ¬
```

---

## ğŸš€ æ­å»ºæ­¥éª¤

### 1. åˆå§‹åŒ–é¡¹ç›®

```bash
mkdir my-monorepo && cd my-monorepo
pnpm init
```

### 2. é…ç½® pnpm workspace

```yaml
# pnpm-workspace.yaml
packages:
  - 'apps/*'
  - 'packages/*'
```

### 3. æ ¹ç›®å½• package.json

```json
{
  "name": "my-monorepo",
  "private": true,
  "scripts": {
    "dev": "turbo dev",
    "build": "turbo build",
    "lint": "turbo lint",
    "test": "turbo test",
    "clean": "turbo clean"
  },
  "devDependencies": {
    "turbo": "^1.10.0"
  },
  "packageManager": "pnpm@8.10.0"
}
```

### 4. é…ç½® Turborepo

```json
// turbo.json
{
  "$schema": "https://turbo.build/schema.json",
  "pipeline": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": ["dist/**", ".next/**"]
    },
    "dev": {
      "cache": false,
      "persistent": true
    },
    "lint": {},
    "test": {
      "dependsOn": ["build"]
    },
    "clean": {
      "cache": false
    }
  }
}
```

---

## ğŸ“¦ åˆ›å»ºå…±äº«åŒ…

### packages/ui/package.json

```json
{
  "name": "@repo/ui",
  "version": "0.0.0",
  "private": true,
  "main": "./src/index.ts",
  "types": "./src/index.ts",
  "exports": {
    ".": "./src/index.ts",
    "./button": "./src/button.tsx"
  },
  "scripts": {
    "lint": "eslint src/",
    "build": "tsup src/index.ts --format esm,cjs --dts"
  },
  "peerDependencies": {
    "react": "^18.0.0"
  },
  "devDependencies": {
    "@repo/config": "workspace:*",
    "tsup": "^7.0.0",
    "typescript": "^5.0.0"
  }
}
```

### packages/ui/src/button.tsx

```tsx
import { ButtonHTMLAttributes } from 'react';

interface ButtonProps extends ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: 'primary' | 'secondary';
}

export function Button({ variant = 'primary', children, ...props }: ButtonProps) {
  return (
    <button className={`btn btn-${variant}`} {...props}>
      {children}
    </button>
  );
}
```

### packages/ui/src/index.ts

```ts
export { Button } from './button';
```

---

## ğŸ”— åŒ…ä¹‹é—´çš„ä¾èµ–

### åœ¨åº”ç”¨ä¸­ä½¿ç”¨å…±äº«åŒ…

```json
// apps/web/package.json
{
  "name": "@repo/web",
  "dependencies": {
    "@repo/ui": "workspace:*",
    "@repo/utils": "workspace:*"
  }
}
```

```tsx
// apps/web/src/app/page.tsx
import { Button } from '@repo/ui';
import { formatDate } from '@repo/utils';

export default function Page() {
  return (
    <div>
      <Button onClick={() => console.log('clicked')}>
        Click me
      </Button>
      <p>{formatDate(new Date())}</p>
    </div>
  );
}
```

### å®‰è£…ä¾èµ–

```bash
# å®‰è£…åˆ°ç‰¹å®šåŒ…
pnpm add lodash --filter @repo/web

# å®‰è£…åˆ°æ ¹ç›®å½•
pnpm add -D typescript -w

# å®‰è£…åˆ°æ‰€æœ‰åŒ…
pnpm add -r react
```

---

## âš™ï¸ å…±äº«é…ç½®

### packages/config/tsconfig/base.json

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "moduleResolution": "bundler",
    "strict": true,
    "skipLibCheck": true,
    "declaration": true,
    "declarationMap": true,
    "esModuleInterop": true,
    "forceConsistentCasingInFileNames": true,
    "isolatedModules": true,
    "jsx": "react-jsx"
  }
}
```

### åœ¨åŒ…ä¸­ä½¿ç”¨

```json
// packages/ui/tsconfig.json
{
  "extends": "@repo/config/tsconfig/base.json",
  "compilerOptions": {
    "outDir": "./dist"
  },
  "include": ["src"],
  "exclude": ["node_modules", "dist"]
}
```

---

## ğŸƒ è¿è¡Œå‘½ä»¤

### å¼€å‘

```bash
# è¿è¡Œæ‰€æœ‰åº”ç”¨
pnpm dev

# åªè¿è¡Œç‰¹å®šåº”ç”¨
pnpm dev --filter @repo/web

# è¿è¡Œåº”ç”¨åŠå…¶ä¾èµ–
pnpm dev --filter @repo/web...
```

### æ„å»º

```bash
# æ„å»ºæ‰€æœ‰
pnpm build

# åªæ„å»ºå˜æ›´çš„åŒ…
turbo build --filter=[HEAD^1]

# å¹¶è¡Œæ„å»º
turbo build --concurrency=10
```

### ç¼“å­˜

```bash
# æŸ¥çœ‹ç¼“å­˜çŠ¶æ€
turbo build --dry-run

# å¼ºåˆ¶å¿½ç•¥ç¼“å­˜
turbo build --force

# è¿œç¨‹ç¼“å­˜ï¼ˆå›¢é˜Ÿå…±äº«ï¼‰
turbo login
turbo link
```

---

## ğŸ“‹ ç‰ˆæœ¬ç®¡ç†

### ä½¿ç”¨ Changesets

```bash
pnpm add -Dw @changesets/cli
pnpm changeset init
```

### æ·»åŠ å˜æ›´

```bash
pnpm changeset
# é€‰æ‹©å˜æ›´çš„åŒ…
# é€‰æ‹©ç‰ˆæœ¬ç±»å‹ï¼ˆpatch/minor/majorï¼‰
# æ·»åŠ å˜æ›´æè¿°
```

### å‘å¸ƒ

```bash
pnpm changeset version  # æ›´æ–°ç‰ˆæœ¬å·
pnpm changeset publish  # å‘å¸ƒåˆ° npm
```

---

## ğŸ”§ å¸¸è§é—®é¢˜

### 1. ä¾èµ–æå‡

```yaml
# .npmrc
shamefully-hoist=true  # å¿…è¦æ—¶å¯ç”¨
```

### 2. ç±»å‹å¼•ç”¨

```json
// tsconfig.json
{
  "compilerOptions": {
    "paths": {
      "@repo/ui": ["../../packages/ui/src"],
      "@repo/utils": ["../../packages/utils/src"]
    }
  }
}
```

### 3. æ„å»ºé¡ºåº

```json
// turbo.json
{
  "pipeline": {
    "build": {
      "dependsOn": ["^build"]  // å…ˆæ„å»ºä¾èµ–
    }
  }
}
```

---

## âœ… æœ€ä½³å®è·µ

```markdown
1. åŒ…å‘½åç»Ÿä¸€ scope
   - @repo/ui, @repo/utils, @repo/config

2. æ˜ç¡®åŒ…çš„è¾¹ç•Œ
   - æ¯ä¸ªåŒ…èŒè´£å•ä¸€
   - é¿å…å¾ªç¯ä¾èµ–

3. ç»Ÿä¸€å·¥å…·é“¾
   - å…±äº« ESLintã€Prettierã€TypeScript é…ç½®
   - ç»Ÿä¸€è„šæœ¬å‘½åï¼ˆdev, build, lint, testï¼‰

4. ä¼˜åŒ– CI/CD
   - åˆ©ç”¨ç¼“å­˜å‡å°‘æ„å»ºæ—¶é—´
   - åªæ„å»ºå—å½±å“çš„åŒ…

5. æ–‡æ¡£å®Œå–„
   - æ¯ä¸ªåŒ…æœ‰ README
   - è´¡çŒ®æŒ‡å—
```

---

## ğŸ“š æ¨èèµ„æº

- [Turborepo æ–‡æ¡£](https://turbo.build/repo/docs)
- [pnpm Workspaces](https://pnpm.io/workspaces)
- [Monorepo.tools](https://monorepo.tools/)

---

Monorepo é€‚åˆæœ‰å¤šä¸ªç›¸å…³é¡¹ç›®çš„åœºæ™¯ã€‚é€‰æ‹©åˆé€‚çš„å·¥å…·ï¼Œå»ºç«‹å¥½è§„èŒƒï¼Œèƒ½å¤§å¹…æå‡å¼€å‘æ•ˆç‡ã€‚
