---
slug: graphql-intro
title: GraphQL å…¥é—¨æŒ‡å—
authors: mason
tags: [GraphQL, API, åç«¯]
---

GraphQL æ˜¯ä¸€ç§ API æŸ¥è¯¢è¯­è¨€ï¼Œè®©å®¢æˆ·ç«¯ç²¾ç¡®è·å–æ‰€éœ€æ•°æ®ã€‚æœ¬æ–‡ä»‹ç» GraphQL çš„æ ¸å¿ƒæ¦‚å¿µå’Œä½¿ç”¨æ–¹æ³•ã€‚

<!--truncate-->

## ğŸ¯ GraphQL vs REST

| ç‰¹æ€§ | REST | GraphQL |
|------|------|---------|
| ç«¯ç‚¹ | å¤šä¸ª `/users`, `/posts` | å•ä¸ª `/graphql` |
| æ•°æ®è·å– | å›ºå®šç»“æ„ | æŒ‰éœ€æŸ¥è¯¢ |
| è¿‡åº¦è·å– | å¸¸è§ | é¿å… |
| å¤šæ¬¡è¯·æ±‚ | éœ€è¦å¤šä¸ªè¯·æ±‚ | ä¸€æ¬¡è¯·æ±‚ |
| ç‰ˆæœ¬æ§åˆ¶ | `/v1`, `/v2` | æ— éœ€ç‰ˆæœ¬ |
| ç±»å‹ç³»ç»Ÿ | æ—  | å¼ºç±»å‹ |

---

## ğŸ“ åŸºç¡€è¯­æ³•

### æŸ¥è¯¢ (Query)

```graphql
# åŸºç¡€æŸ¥è¯¢
query {
  user(id: "1") {
    id
    name
    email
  }
}

# å“åº”
{
  "data": {
    "user": {
      "id": "1",
      "name": "John",
      "email": "john@example.com"
    }
  }
}
```

### åµŒå¥—æŸ¥è¯¢

```graphql
query {
  user(id: "1") {
    name
    posts {
      title
      comments {
        content
        author {
          name
        }
      }
    }
  }
}
```

### å˜é‡

```graphql
query GetUser($id: ID!) {
  user(id: $id) {
    name
    email
  }
}

# å˜é‡
{
  "id": "1"
}
```

### åˆ«å

```graphql
query {
  admin: user(id: "1") {
    name
  }
  guest: user(id: "2") {
    name
  }
}
```

### ç‰‡æ®µ (Fragment)

```graphql
fragment UserFields on User {
  id
  name
  email
  avatar
}

query {
  user(id: "1") {
    ...UserFields
    posts {
      title
    }
  }
  
  users {
    ...UserFields
  }
}
```

---

## âœï¸ å˜æ›´ (Mutation)

```graphql
mutation CreateUser($input: CreateUserInput!) {
  createUser(input: $input) {
    id
    name
    email
  }
}

# å˜é‡
{
  "input": {
    "name": "John",
    "email": "john@example.com"
  }
}
```

```graphql
mutation UpdateUser($id: ID!, $input: UpdateUserInput!) {
  updateUser(id: $id, input: $input) {
    id
    name
  }
}

mutation DeleteUser($id: ID!) {
  deleteUser(id: $id) {
    success
    message
  }
}
```

---

## ğŸ“¡ è®¢é˜… (Subscription)

```graphql
subscription OnMessageCreated($channelId: ID!) {
  messageCreated(channelId: $channelId) {
    id
    content
    author {
      name
    }
    createdAt
  }
}
```

---

## ğŸ—ï¸ Schema å®šä¹‰

### ç±»å‹å®šä¹‰

```graphql
# å¯¹è±¡ç±»å‹
type User {
  id: ID!
  name: String!
  email: String!
  age: Int
  isActive: Boolean!
  posts: [Post!]!
  createdAt: DateTime!
}

type Post {
  id: ID!
  title: String!
  content: String!
  author: User!
  tags: [String!]
  published: Boolean!
}

# è¾“å…¥ç±»å‹
input CreateUserInput {
  name: String!
  email: String!
  age: Int
}

input UpdateUserInput {
  name: String
  email: String
  age: Int
}

# æšä¸¾
enum Role {
  ADMIN
  USER
  GUEST
}

# æ¥å£
interface Node {
  id: ID!
}

type User implements Node {
  id: ID!
  name: String!
}
```

### æ ¹ç±»å‹

```graphql
type Query {
  user(id: ID!): User
  users(limit: Int, offset: Int): [User!]!
  post(id: ID!): Post
  posts(authorId: ID): [Post!]!
}

type Mutation {
  createUser(input: CreateUserInput!): User!
  updateUser(id: ID!, input: UpdateUserInput!): User
  deleteUser(id: ID!): Boolean!
  createPost(input: CreatePostInput!): Post!
}

type Subscription {
  userCreated: User!
  postPublished: Post!
}
```

---

## ğŸ–¥ï¸ æœåŠ¡ç«¯å®ç° (Node.js)

### Apollo Server

```javascript
import { ApolloServer } from '@apollo/server';
import { startStandaloneServer } from '@apollo/server/standalone';

// ç±»å‹å®šä¹‰
const typeDefs = `
  type User {
    id: ID!
    name: String!
    email: String!
  }

  type Query {
    users: [User!]!
    user(id: ID!): User
  }

  type Mutation {
    createUser(name: String!, email: String!): User!
  }
`;

// è§£æå™¨
const resolvers = {
  Query: {
    users: () => db.users.findMany(),
    user: (_, { id }) => db.users.findById(id),
  },
  Mutation: {
    createUser: (_, { name, email }) => {
      return db.users.create({ name, email });
    },
  },
};

// åˆ›å»ºæœåŠ¡å™¨
const server = new ApolloServer({
  typeDefs,
  resolvers,
});

const { url } = await startStandaloneServer(server, {
  listen: { port: 4000 },
});

console.log(`Server ready at ${url}`);
```

### è§£æå™¨ä¸Šä¸‹æ–‡

```javascript
const resolvers = {
  Query: {
    me: (parent, args, context) => {
      // context åŒ…å«è¯·æ±‚ä¿¡æ¯ã€è®¤è¯ç­‰
      if (!context.user) {
        throw new Error('Not authenticated');
      }
      return context.user;
    },
  },
  User: {
    // å­—æ®µè§£æå™¨
    posts: (parent, args, context) => {
      return db.posts.findByAuthorId(parent.id);
    },
  },
};

// è®¾ç½® context
const { url } = await startStandaloneServer(server, {
  context: async ({ req }) => ({
    user: await getUserFromToken(req.headers.authorization),
  }),
});
```

---

## ğŸ“± å®¢æˆ·ç«¯ä½¿ç”¨

### Apollo Client (React)

```javascript
import { ApolloClient, InMemoryCache, ApolloProvider, gql, useQuery, useMutation } from '@apollo/client';

// åˆ›å»ºå®¢æˆ·ç«¯
const client = new ApolloClient({
  uri: 'http://localhost:4000/graphql',
  cache: new InMemoryCache(),
});

// Provider
function App() {
  return (
    <ApolloProvider client={client}>
      <UserList />
    </ApolloProvider>
  );
}
```

### useQuery

```javascript
const GET_USERS = gql`
  query GetUsers {
    users {
      id
      name
      email
    }
  }
`;

function UserList() {
  const { loading, error, data, refetch } = useQuery(GET_USERS);

  if (loading) return <p>Loading...</p>;
  if (error) return <p>Error: {error.message}</p>;

  return (
    <ul>
      {data.users.map(user => (
        <li key={user.id}>{user.name}</li>
      ))}
    </ul>
  );
}
```

### useMutation

```javascript
const CREATE_USER = gql`
  mutation CreateUser($name: String!, $email: String!) {
    createUser(name: $name, email: $email) {
      id
      name
      email
    }
  }
`;

function CreateUserForm() {
  const [createUser, { loading, error }] = useMutation(CREATE_USER, {
    refetchQueries: ['GetUsers'], // åˆ·æ–°åˆ—è¡¨
  });

  const handleSubmit = async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    
    await createUser({
      variables: {
        name: formData.get('name'),
        email: formData.get('email'),
      },
    });
  };

  return (
    <form onSubmit={handleSubmit}>
      <input name="name" placeholder="Name" />
      <input name="email" placeholder="Email" />
      <button type="submit" disabled={loading}>
        {loading ? 'Creating...' : 'Create'}
      </button>
      {error && <p>Error: {error.message}</p>}
    </form>
  );
}
```

---

## ğŸ”§ æœ€ä½³å®è·µ

### åˆ†é¡µ

```graphql
type Query {
  posts(first: Int, after: String): PostConnection!
}

type PostConnection {
  edges: [PostEdge!]!
  pageInfo: PageInfo!
}

type PostEdge {
  node: Post!
  cursor: String!
}

type PageInfo {
  hasNextPage: Boolean!
  endCursor: String
}
```

### é”™è¯¯å¤„ç†

```graphql
type MutationResult {
  success: Boolean!
  message: String
  errors: [Error!]
}

type Error {
  field: String
  message: String!
}
```

### N+1 é—®é¢˜

```javascript
// ä½¿ç”¨ DataLoader è§£å†³
import DataLoader from 'dataloader';

const userLoader = new DataLoader(async (ids) => {
  const users = await db.users.findMany({
    where: { id: { in: ids } },
  });
  return ids.map(id => users.find(u => u.id === id));
});

const resolvers = {
  Post: {
    author: (post) => userLoader.load(post.authorId),
  },
};
```

---

## ğŸ“‹ å¯¹æ¯”æ€»ç»“

| åœºæ™¯ | æ¨è |
|------|------|
| ç®€å• CRUD | REST |
| å¤æ‚æ•°æ®å…³ç³» | GraphQL |
| ç§»åŠ¨ç«¯/å¸¦å®½æ•æ„Ÿ | GraphQL |
| å…¬å¼€ API | REST |
| å†…éƒ¨ API | GraphQL |
| å¾®æœåŠ¡èšåˆ | GraphQL |

---

GraphQL ä¸æ˜¯ REST çš„æ›¿ä»£å“ï¼Œè€Œæ˜¯å¦ä¸€ç§é€‰æ‹©ã€‚æ ¹æ®é¡¹ç›®éœ€æ±‚é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆã€‚
