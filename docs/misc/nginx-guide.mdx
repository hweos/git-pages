---
sidebar_position: 8
slug: nginx-guide
title: Nginx é…ç½®é€ŸæŸ¥
description: Nginx åå‘ä»£ç†ã€HTTPSã€è´Ÿè½½å‡è¡¡é…ç½®æŒ‡å—
---

# Nginx é…ç½®é€ŸæŸ¥

Nginx æ˜¯é«˜æ€§èƒ½çš„ Web æœåŠ¡å™¨å’Œåå‘ä»£ç†æœåŠ¡å™¨ã€‚æœ¬æ–‡æ€»ç»“å¸¸ç”¨é…ç½®ã€‚

## ğŸ“ é…ç½®æ–‡ä»¶ç»“æ„

```
/etc/nginx/
â”œâ”€â”€ nginx.conf          # ä¸»é…ç½®
â”œâ”€â”€ conf.d/             # è‡ªå®šä¹‰é…ç½®
â”‚   â””â”€â”€ default.conf
â”œâ”€â”€ sites-available/    # å¯ç”¨ç«™ç‚¹
â”œâ”€â”€ sites-enabled/      # å·²å¯ç”¨ç«™ç‚¹
â””â”€â”€ snippets/           # é…ç½®ç‰‡æ®µ
```

---

## ğŸ”§ åŸºç¡€é…ç½®

### é™æ€æ–‡ä»¶æœåŠ¡

```nginx
server {
    listen 80;
    server_name example.com;
    
    root /var/www/html;
    index index.html;
    
    location / {
        try_files $uri $uri/ =404;
    }
    
    # é™æ€èµ„æºç¼“å­˜
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
}
```

### SPA åº”ç”¨é…ç½®

```nginx
server {
    listen 80;
    server_name app.example.com;
    
    root /var/www/app;
    index index.html;
    
    # æ‰€æœ‰è·¯ç”±æŒ‡å‘ index.html
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # API ä»£ç†
    location /api/ {
        proxy_pass http://localhost:3000/;
    }
}
```

---

## ğŸ”„ åå‘ä»£ç†

### åŸºç¡€ä»£ç†

```nginx
server {
    listen 80;
    server_name api.example.com;
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### WebSocket ä»£ç†

```nginx
location /ws/ {
    proxy_pass http://localhost:3001;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_read_timeout 86400;
}
```

### å¤šè·¯å¾„ä»£ç†

```nginx
server {
    listen 80;
    server_name example.com;
    
    # å‰ç«¯
    location / {
        proxy_pass http://localhost:3000;
    }
    
    # åç«¯ API
    location /api/ {
        proxy_pass http://localhost:8080/;
    }
    
    # ç®¡ç†åå°
    location /admin/ {
        proxy_pass http://localhost:8081/;
    }
}
```

---

## ğŸ”’ HTTPS é…ç½®

### Let's Encrypt è¯ä¹¦

```nginx
server {
    listen 80;
    server_name example.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name example.com;
    
    ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;
    
    # SSL ä¼˜åŒ–
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;
    
    # HSTS
    add_header Strict-Transport-Security "max-age=31536000" always;
    
    root /var/www/html;
    index index.html;
}
```

### ä½¿ç”¨ Certbot è·å–è¯ä¹¦

```bash
# å®‰è£… Certbot
sudo apt install certbot python3-certbot-nginx

# è·å–è¯ä¹¦
sudo certbot --nginx -d example.com -d www.example.com

# è‡ªåŠ¨ç»­æœŸ
sudo certbot renew --dry-run
```

---

## âš–ï¸ è´Ÿè½½å‡è¡¡

### è½®è¯¢ï¼ˆé»˜è®¤ï¼‰

```nginx
upstream backend {
    server 127.0.0.1:3001;
    server 127.0.0.1:3002;
    server 127.0.0.1:3003;
}

server {
    listen 80;
    
    location / {
        proxy_pass http://backend;
    }
}
```

### æƒé‡åˆ†é…

```nginx
upstream backend {
    server 127.0.0.1:3001 weight=3;
    server 127.0.0.1:3002 weight=2;
    server 127.0.0.1:3003 weight=1;
}
```

### IP Hashï¼ˆä¼šè¯ä¿æŒï¼‰

```nginx
upstream backend {
    ip_hash;
    server 127.0.0.1:3001;
    server 127.0.0.1:3002;
}
```

### å¥åº·æ£€æŸ¥

```nginx
upstream backend {
    server 127.0.0.1:3001 max_fails=3 fail_timeout=30s;
    server 127.0.0.1:3002 max_fails=3 fail_timeout=30s;
    server 127.0.0.1:3003 backup;  # å¤‡ç”¨æœåŠ¡å™¨
}
```

---

## ğŸ›¡ï¸ å®‰å…¨é…ç½®

### åŸºç¡€å®‰å…¨å¤´

```nginx
# éšè—ç‰ˆæœ¬å·
server_tokens off;

# å®‰å…¨å¤´
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
```

### é™æµ

```nginx
# å®šä¹‰é™æµåŒºåŸŸ
limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;

server {
    location /api/ {
        limit_req zone=api burst=20 nodelay;
        proxy_pass http://localhost:3000;
    }
}
```

### IP ç™½åå•/é»‘åå•

```nginx
# ç™½åå•
location /admin/ {
    allow 192.168.1.0/24;
    allow 10.0.0.1;
    deny all;
    proxy_pass http://localhost:8080;
}

# é»‘åå•
location / {
    deny 192.168.1.100;
    deny 10.0.0.0/8;
    allow all;
}
```

### åŸºç¡€è®¤è¯

```bash
# åˆ›å»ºå¯†ç æ–‡ä»¶
sudo htpasswd -c /etc/nginx/.htpasswd admin
```

```nginx
location /admin/ {
    auth_basic "Admin Area";
    auth_basic_user_file /etc/nginx/.htpasswd;
    proxy_pass http://localhost:8080;
}
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### Gzip å‹ç¼©

```nginx
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_comp_level 5;
gzip_types
    text/plain
    text/css
    text/javascript
    application/javascript
    application/json
    application/xml
    image/svg+xml;
```

### ç¼“å­˜é…ç½®

```nginx
# ä»£ç†ç¼“å­˜
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=1g inactive=60m;

server {
    location / {
        proxy_cache my_cache;
        proxy_cache_valid 200 60m;
        proxy_cache_valid 404 1m;
        add_header X-Cache-Status $upstream_cache_status;
        proxy_pass http://backend;
    }
}
```

### è¿æ¥ä¼˜åŒ–

```nginx
# åœ¨ http å—ä¸­
keepalive_timeout 65;
keepalive_requests 100;

# upstream è¿æ¥æ± 
upstream backend {
    server 127.0.0.1:3000;
    keepalive 32;
}
```

---

## ğŸ” å¸¸ç”¨å‘½ä»¤

```bash
# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡æ–°åŠ è½½é…ç½®
sudo nginx -s reload

# å¯åŠ¨/åœæ­¢/é‡å¯
sudo systemctl start nginx
sudo systemctl stop nginx
sudo systemctl restart nginx

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status nginx

# æŸ¥çœ‹æ—¥å¿—
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log
```

---

## ğŸ“š æ¨èèµ„æº

- [Nginx å®˜æ–¹æ–‡æ¡£](https://nginx.org/en/docs/)
- [Nginx Config Generator](https://www.digitalocean.com/community/tools/nginx)
- [Mozilla SSL é…ç½®ç”Ÿæˆå™¨](https://ssl-config.mozilla.org/)
