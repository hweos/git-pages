---
sidebar_position: 4
slug: pm2-guide
title: PM2 ä½¿ç”¨æŒ‡å—
description: Node.js è¿›ç¨‹ç®¡ç†å·¥å…· PM2 çš„å®Œæ•´ä½¿ç”¨æŒ‡å—
---

# PM2 ä½¿ç”¨æŒ‡å—

PM2 æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„ Node.js è¿›ç¨‹ç®¡ç†å·¥å…·ï¼Œç”¨äºåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç®¡ç†å’Œä¿æŒåº”ç”¨ç¨‹åºæŒç»­è¿è¡Œã€‚

## ğŸ“¦ å®‰è£…

```bash
# å…¨å±€å®‰è£… PM2
npm install pm2 -g

# æˆ–ä½¿ç”¨ yarn
yarn global add pm2
```

## ğŸš€ åŸºæœ¬ä½¿ç”¨

### å¯åŠ¨åº”ç”¨

```bash
# å¯åŠ¨åº”ç”¨
pm2 start app.js

# æŒ‡å®šåº”ç”¨åç§°
pm2 start app.js --name "my-app"

# å¯åŠ¨å¹¶ç›‘å¬æ–‡ä»¶å˜åŒ–ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
pm2 start app.js --watch

# å¯åŠ¨æ—¶æŒ‡å®šå®ä¾‹æ•°é‡ï¼ˆé›†ç¾¤æ¨¡å¼ï¼‰
pm2 start app.js -i max  # ä½¿ç”¨æ‰€æœ‰ CPU æ ¸å¿ƒ
pm2 start app.js -i 4    # å¯åŠ¨ 4 ä¸ªå®ä¾‹
```

### å¸¸ç”¨å¯åŠ¨å‚æ•°

```bash
# è®¾ç½®ç¯å¢ƒå˜é‡
pm2 start app.js --env production

# æŒ‡å®šæ—¥å¿—æ–‡ä»¶
pm2 start app.js --log /path/to/log.log

# è®¾ç½®å†…å­˜é™åˆ¶ï¼Œè¶…è¿‡åè‡ªåŠ¨é‡å¯
pm2 start app.js --max-memory-restart 200M

# å»¶è¿Ÿé‡å¯ï¼ˆå´©æºƒåç­‰å¾… 3 ç§’å†é‡å¯ï¼‰
pm2 start app.js --restart-delay 3000
```

## ğŸ“‹ è¿›ç¨‹ç®¡ç†

### æŸ¥çœ‹è¿›ç¨‹åˆ—è¡¨

```bash
# æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹
pm2 list

# æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
pm2 show <app-name>

# å®æ—¶ç›‘æ§é¢æ¿
pm2 monit
```

### æ§åˆ¶è¿›ç¨‹

```bash
# é‡å¯åº”ç”¨
pm2 restart <app-name>
pm2 restart all          # é‡å¯æ‰€æœ‰

# åœæ­¢åº”ç”¨
pm2 stop <app-name>
pm2 stop all             # åœæ­¢æ‰€æœ‰

# åˆ é™¤åº”ç”¨
pm2 delete <app-name>
pm2 delete all           # åˆ é™¤æ‰€æœ‰

# é‡è½½åº”ç”¨ï¼ˆé›¶åœæœºé‡å¯ï¼Œé€‚ç”¨äºé›†ç¾¤æ¨¡å¼ï¼‰
pm2 reload <app-name>
pm2 reload all
```

## ğŸ“ æ—¥å¿—ç®¡ç†

```bash
# æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—
pm2 logs

# æŸ¥çœ‹æŒ‡å®šåº”ç”¨æ—¥å¿—
pm2 logs <app-name>

# æŸ¥çœ‹æœ€è¿‘ 200 è¡Œæ—¥å¿—
pm2 logs --lines 200

# æ¸…ç©ºæ—¥å¿—
pm2 flush

# æ—¥å¿—è½®è½¬ï¼ˆéœ€è¦å®‰è£… pm2-logrotateï¼‰
pm2 install pm2-logrotate
```

## âš™ï¸ é…ç½®æ–‡ä»¶

ä½¿ç”¨é…ç½®æ–‡ä»¶å¯ä»¥æ›´æ–¹ä¾¿åœ°ç®¡ç†å¤æ‚çš„åº”ç”¨é…ç½®ã€‚

### ç”Ÿæˆé…ç½®æ–‡ä»¶

```bash
pm2 ecosystem
```

### ecosystem.config.js ç¤ºä¾‹

```javascript
module.exports = {
  apps: [
    {
      name: 'my-app',
      script: './app.js',
      instances: 'max',
      exec_mode: 'cluster',
      watch: false,
      max_memory_restart: '1G',
      env: {
        NODE_ENV: 'development',
        PORT: 3000
      },
      env_production: {
        NODE_ENV: 'production',
        PORT: 8080
      },
      // æ—¥å¿—é…ç½®
      log_date_format: 'YYYY-MM-DD HH:mm:ss',
      error_file: './logs/error.log',
      out_file: './logs/out.log',
      merge_logs: true,
      // é‡å¯ç­–ç•¥
      max_restarts: 10,
      restart_delay: 4000,
      autorestart: true
    }
  ],
  
  // éƒ¨ç½²é…ç½®ï¼ˆå¯é€‰ï¼‰
  deploy: {
    production: {
      user: 'root',
      host: 'your-server.com',
      ref: 'origin/main',
      repo: 'git@github.com:user/repo.git',
      path: '/var/www/production',
      'post-deploy': 'npm install && pm2 reload ecosystem.config.js --env production'
    }
  }
};
```

### ä½¿ç”¨é…ç½®æ–‡ä»¶å¯åŠ¨

```bash
# å¯åŠ¨æ‰€æœ‰åº”ç”¨
pm2 start ecosystem.config.js

# å¯åŠ¨æŒ‡å®šåº”ç”¨
pm2 start ecosystem.config.js --only my-app

# ä½¿ç”¨ç”Ÿäº§ç¯å¢ƒé…ç½®
pm2 start ecosystem.config.js --env production
```

## ğŸ”„ å¼€æœºè‡ªå¯åŠ¨

```bash
# ç”Ÿæˆå¯åŠ¨è„šæœ¬
pm2 startup

# ä¿å­˜å½“å‰è¿›ç¨‹åˆ—è¡¨
pm2 save

# æ¢å¤ä¹‹å‰ä¿å­˜çš„è¿›ç¨‹
pm2 resurrect

# å–æ¶ˆå¼€æœºè‡ªå¯åŠ¨
pm2 unstartup
```

## ğŸ“Š ç›‘æ§ä¸è¯Šæ–­

```bash
# å®æ—¶ç›‘æ§é¢æ¿
pm2 monit

# æŸ¥çœ‹è¿›ç¨‹è¯¦æƒ…
pm2 describe <app-name>

# æŸ¥çœ‹è¿›ç¨‹ä¿¡æ¯ï¼ˆJSON æ ¼å¼ï¼‰
pm2 jlist

# é‡ç½®é‡å¯è®¡æ•°
pm2 reset <app-name>
```

## ğŸŒ PM2 Plusï¼ˆå¯é€‰ï¼‰

PM2 æä¾›äº†ä¸€ä¸ª Web ç›‘æ§å¹³å° PM2 Plusï¼š

```bash
# è¿æ¥åˆ° PM2 Plus
pm2 plus
```

## ğŸ’¡ å¸¸ç”¨æŠ€å·§

### å¿«é€Ÿé‡å¯æ‰€æœ‰åº”ç”¨

```bash
pm2 restart all --update-env
```

### ä¼˜é›…å…³é—­åº”ç”¨

åœ¨ä»£ç ä¸­å¤„ç† `SIGINT` ä¿¡å·ï¼š

```javascript
process.on('SIGINT', () => {
  // æ¸…ç†èµ„æº
  db.close();
  server.close(() => {
    process.exit(0);
  });
});
```

### æŸ¥çœ‹ CPU å’Œå†…å­˜ä½¿ç”¨

```bash
pm2 monit
```

### é›†ç¾¤æ¨¡å¼ä¸‹é›¶åœæœºæ›´æ–°

```bash
pm2 reload all
```

## â“ å¸¸è§é—®é¢˜

### Q1: åº”ç”¨é¢‘ç¹é‡å¯

æ£€æŸ¥æ—¥å¿—æ‰¾å‡ºå´©æºƒåŸå› ï¼š

```bash
pm2 logs <app-name> --lines 100
```

### Q2: å†…å­˜æŒç»­å¢é•¿

è®¾ç½®å†…å­˜é™åˆ¶è‡ªåŠ¨é‡å¯ï¼š

```bash
pm2 start app.js --max-memory-restart 500M
```

### Q3: å¦‚ä½•æŸ¥çœ‹åº”ç”¨çŠ¶æ€

```bash
pm2 status
# æˆ–
pm2 list
```

## ğŸ“š å‚è€ƒèµ„æ–™

- [PM2 å®˜æ–¹æ–‡æ¡£](https://pm2.keymetrics.io/docs/usage/quick-start/)
- [PM2 GitHub](https://github.com/Unitech/pm2)

